# frozen_string_literal: true

require 'rails_helper'
require_relative '../sign_in_controller_shared_examples_spec'

RSpec.describe V0::SignInController, type: :controller do
  include_context 'authorize_shared_setup'

  describe 'GET authorize' do
    subject do
      get(:authorize, params: authorize_params)
    end

    let(:authorize_params) do
      {}.merge(type)
        .merge(code_challenge)
        .merge(code_challenge_method)
        .merge(client_state)
        .merge(client_id)
        .merge(acr)
        .merge(operation)
        .merge(scope)
    end
    let(:client_id_value) { client_config.client_id }
    let(:expected_redirect_uri_param) { { redirect_uri: expected_redirect_uri }.to_query }
    let(:statsd_tags) do
      ["type:#{type_value}", "client_id:#{client_id_value}", "acr:#{acr_value}", "operation:#{operation_value}"]
    end

    shared_context 'a logingov authentication service interface' do
      context 'and acr param is not given' do
        let(:acr) { {} }
        let(:acr_value) { nil }
        let(:expected_error) { 'ACR is not valid' }

        it_behaves_like 'error response'
      end

      context 'and acr param is given but not in client service_levels' do
        let(:acr_value) { 'ial1' }
        let(:service_levels) { ['ial2'] }
        let(:expected_error) { 'ACR is not valid' }

        it_behaves_like 'error response'
      end

      context 'and acr param is given and in client service_levels but not valid for logingov' do
        let(:acr_value) { 'loa1' }
        let(:expected_error) { 'Invalid ACR for logingov' }

        it_behaves_like 'error response'
      end

      context 'and acr param is given and in client service_levels and valid for logingov' do
        let(:acr_value) { 'ial1' }

        context 'and code_challenge_method is not given' do
          let(:code_challenge_method) { {} }

          context 'and client is configured with pkce enabled' do
            let(:pkce) { true }
            let(:expected_error) { 'Code Challenge Method is not valid' }

            it_behaves_like 'error response'
          end

          context 'and client is configured with pkce disabled' do
            let(:pkce) { false }

            it_behaves_like 'expected response with optional client state'
          end
        end

        context 'and code_challenge_method is S256' do
          let(:code_challenge_method) { { code_challenge_method: 'S256' } }

          context 'and code_challenge is not given' do
            let(:code_challenge) { {} }

            context 'and client is configured with pkce enabled' do
              let(:pkce) { true }
              let(:expected_error) { 'Code Challenge is not valid' }

              it_behaves_like 'error response'
            end

            context 'and client is configured with pkce disabled' do
              let(:pkce) { false }

              it_behaves_like 'expected response with optional client state'
            end
          end

          context 'and code_challenge is not properly URL encoded' do
            let(:code_challenge) { { code_challenge: '///some+unsafe code+challenge//' } }

            context 'and client is configured with pkce enabled' do
              let(:pkce) { true }
              let(:expected_error) { 'Code Challenge is not valid' }
              let(:expected_error_json) { { 'errors' => expected_error } }

              it_behaves_like 'error response'
            end

            context 'and client is configured with pkce disabled' do
              let(:pkce) { false }

              it_behaves_like 'expected response with optional client state'
            end
          end

          context 'and code_challenge is properly URL encoded' do
            let(:code_challenge) { { code_challenge: Base64.urlsafe_encode64('some-safe-code-challenge') } }

            it_behaves_like 'expected response with optional client state'
          end
        end

        context 'and code_challenge_method is not S256' do
          context 'and client is configured with pkce enabled' do
            let(:pkce) { true }
            let(:expected_error) { 'Code Challenge Method is not valid' }

            it_behaves_like 'error response'
          end

          context 'and client is configured with pkce disabled' do
            let(:pkce) { false }

            it_behaves_like 'expected response with optional client state'
          end
        end
      end
    end

    context 'when type param is logingov' do
      let(:type_value) { SignIn::Constants::Auth::LOGINGOV }
      let(:expected_redirect_uri) { IdentitySettings.logingov.redirect_uri }

      context 'and operation param is not given' do
        let(:operation) { {} }
        let(:expected_op_value) { '' }

        it_behaves_like 'a logingov authentication service interface'
      end

      context 'and operation param is in OPERATION_TYPES' do
        let(:operation_value) { SignIn::Constants::Auth::OPERATION_TYPES.first }
        let(:expected_op_value) { '' }

        it_behaves_like 'a logingov authentication service interface'
      end

      context 'and operation param is arbitrary' do
        let(:operation_value) { 'some-operation-value' }
        let(:expected_error) { 'Operation is not valid' }

        it_behaves_like 'error response'
      end
    end
  end
end
