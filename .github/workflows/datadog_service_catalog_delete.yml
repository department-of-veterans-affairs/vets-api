name: Delete Datadog service from Datadog
on:
  pull_request:

jobs:
  get_deleted_services:
    name: 'Get deleted service filenames'
    runs-on: ubuntu-latest
    outputs:
      files: ${{steps.one.outputs.files}}
    steps:
      - name: 'Checkout repo'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: one
        name: 'Check for deleted DataDog service files'
        run: |
          arr=$(jq -ncR '[inputs]' <<< $(git diff --diff-filter=D --name-only origin/master.. -- "datadog-service-catalog/**.yml"))
          out=$(echo $arr | jq '.[] | select(. !="datadog-service-catalog/datadog-service-catalog.yml") | [.]')
          echo $out
          echo ::set-output name=files::$out

  delete_services:
    name: 'Delete services from Datadog'
    runs-on: ubuntu-latest
    needs:
      - get_deleted_services
    strategy:
      matrix:
        file: ${{fromJSON(needs.get_deleted_services.outputs.files)}}
    steps:
      - name: 'Checkout master branch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master
      - name: 'Get service names from file'
        id: parse_file
        uses: mikefarah/yq@master
        with:
          cmd: yq '.name' ${{matrix.file}}
      - name: 'Delete service'
        run: |
              echo ${{steps.parse_file.outputs.result}}
