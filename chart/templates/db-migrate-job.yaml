{{- if .Values.web.dbMigrate.enabled }}
---
apiVersion: batch/v1
kind: Job
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ .Values.web.dbMigrate.fullName }}
  annotations:
{{ toYaml .Values.web.dbMigrate.annotations | indent 4 }}
spec:
  template:
    spec:
      serviceAccountName: {{ .Values.web.serviceAccount.name }}
      containers:
        - name: {{ .Values.web.dbMigrate.fullName }}
          image: '{{ .Values.image.value }}:{{ .Values.image.tag }}'
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: {{ .Values.web.dbMigrate.command }}
          args: {{ .Values.web.dbMigrate.args }}
          volumeMounts:
{{ toYaml .Values.common.volumeMounts | indent 12 }}
          env:
{{ toYaml .Values.common.envSecrets | indent 12 }}
          {{- range $keys, $key := .Values.common.secrets }}
          {{- range $secrets, $secret := $key }}
            - name: {{ $secret.env_var }}
              valueFrom:
                secretKeyRef:
                  name: {{ $keys }}
                  key:  {{ $secret.name }}
          {{- end }}
          {{- end }}
      restartPolicy:  {{ .Values.web.dbMigrate.restartPolicy }}
      securityContext:
        fsGroup: 1000
      volumes:
{{ toYaml .Values.common.volumes | indent 8 }}
  backoffLimit: {{ .Values.web.dbMigrate.backoffLimit }}
{{- end }}
