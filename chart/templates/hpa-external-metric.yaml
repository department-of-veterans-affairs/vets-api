{{- $root := . -}}
{{- range $name, $service := $root.Values.web.webServices }}
{{- if $service.autoscaling.enabled }}
---
apiVersion: datadoghq.com/v1alpha1
kind: DatadogMetric
metadata:
  name: puma-backlog-{{ $name }}
  namespace: {{ $root.Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/sync-wave: "-1"
spec:
  query: sum:puma.backlog{deployment_env:vagov-prod} by {autoscaling_group}.rollup(sum)
{{- end }}
{{- end }}
