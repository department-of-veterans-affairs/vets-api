{{- $root := . -}}
{{- range $name, $cronJob := $root.Values.cronJobs }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $name }}
  namespace: {{ $root.Release.Namespace }}
spec:
  schedule: "{{ $cronJob.schedule }}"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      parallelism: 1
      completions: 1
      backoffLimit: 1
      template:
        spec:
          containers:
            - name: {{ $name }}
              image: "{{ $root.Values.image.value }}:{{ $root.Values.image.tag }}"
              imagePullPolicy: {{ $cronJob.imagePullPolicy | default $root.Values.image.pullPolicy }}
              command:
{{ toYaml $cronJob.command | indent 16 }}
              args:
{{ toYaml $cronJob.args | indent 16 }}
              volumeMounts:
{{ toYaml $cronJob.volumeMounts | indent 16 }}
              env:
                - name: GIT_REVISION
                  value: {{ $root.Values.image.tag}}
{{ toYaml $root.Values.web.dbMigrate.envSecrets | indent 16 }}
              {{- range $keys, $key := $root.Values.common.secrets }}
              {{- range $secrets, $secret := $key }}
                - name: {{ $secret.env_var }}
                  valueFrom:
                    secretKeyRef:
                      name: {{ $keys }}
                      key:  {{ $secret.name }}
              {{- end }}
              {{- end }}
          restartPolicy: OnFailure
          securityContext:
            fsGroup: 1000
          volumes:
{{ toYaml $cronJob.volumes | indent 12 }}
{{- end }}
