name: Backend PR Labeler
on:
  pull_request:
    types: [opened, reopened, review_requested, review_request_removed, ready_for_review, converted_to_draft, labeled, unlabeled]
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: 
      - "Code Checks"
    types: [completed]
jobs:
  check-pr-status:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.get_pr_data.outputs.pr_number }}
      pr_draft: ${{ steps.get_pr_data.outputs.pr_draft }}
      pr_labels: ${{ steps.get_pr_data.outputs.pr_labels }}
      pr_requested_teams: ${{ steps.get_pr_data.outputs.pr_requested_teams }}
      test_status: ${{ steps.get_code_checks_conclusion.outputs.test_status }}
      exempt: ${{ steps.check_exemption.outputs.exempt }}
      failures_detected: ${{ steps.audit_pr_labels.outputs.failures_detected }}
    steps:
      # - name: Checkout code
      #   uses: actions/checkout@v4

      - name: Get pull_request data
        id: get_pr_data
        run: |
          if ${{ github.event_name == 'pull_request'}}; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "pr_draft=${{ github.event.pull_request.draft }}" >> $GITHUB_OUTPUT
            echo "pr_labels=$(echo '${{ toJSON(github.event.pull_request.labels.*.name) }}' | jq -c '.')" >> $GITHUB_OUTPUT
            echo "pr_requested_teams=$(echo '${{ toJSON(github.event.pull_request.requested_teams.*.name) }}' | jq -c '.')" >> $GITHUB_OUTPUT
          elif ${{ github.event_name == 'pull_request_review' }}; then
            echo "pr_number=${{ github.event.pull_request_review.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "pr_draft=${{ github.event.pull_request_review.pull_request.draft }}" >> $GITHUB_OUTPUT
            echo "pr_labels=$(echo '${{ toJSON(github.event.pull_request_review.pull_request.labels.*.name) }}' | jq -c '.')" >> $GITHUB_OUTPUT
            echo "pr_requested_teams=$(echo '${{ toJSON(github.event.pull_request_review.pull_request.requested_teams.*.name) }}' | jq -c '.')" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_run" ]] && [[ "${{ toJSON(github.event.workflow_run.pull_requests) }}" != "[]" ]]; then
            echo "pr_number=${{ github.event.workflow_run.pull_requests[0].number }}" >> $GITHUB_OUTPUT
            echo "pr_draft=${{ github.event.workflow_run.pull_requests[0].draft }}" >> $GITHUB_OUTPUT
            echo "pr_labels=$(echo '${{ toJSON(github.event.workflow_run.pull_requests[0].labels.*.name) }}' | jq -c '.')" >> $GITHUB_OUTPUT
            echo "pr_requested_teams=$(echo '${{ toJSON(github.event.workflow_run.pull_requests[0].requested_teams.*.name) }}' | jq -c '.')" >> $GITHUB_OUTPUT
          else
            echo "Pull Request not successfully retrieved."
            exit 1
          fi

      - name: Get Code Checks conclusion
        if: github.event_name == 'workflow_run'
        run: |
          echo "workflow_run: ${{ toJSON(github.event.workflow_run) }}"
          echo "test_status=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
          echo "test_status: ${{ github.event.workflow_run.conclusion }}"

      - name: Check for exemption
        id: check_exemption
        run: |
          if ${{ contains(fromJSON(steps.get_pr_data.outputs.pr_requested_teams), 'backend-review-group') }}; then
            echo "exempt=false" >> $GITHUB_OUTPUT
            echo "PR requires backend approval."
          else
            echo "exempt=true" >> $GITHUB_OUTPUT
            echo "PR is exempt from backend approval."
          fi

      - name: Check for failure labels
        id: audit_pr_labels
        env:
          labels: ${{ steps.get_pr_data.outputs.pr_labels }}
        run: |
          if [[ \
            ${{ contains(env.labels, 'code-health-failure') == 'true' }} || \
            ${{ contains(env.labels, 'codeowners-addition-failure') == 'true' }} || \
            ${{ contains(env.labels, 'codeowners-delete-failure') == 'true' }} || \
            ${{ contains(env.labels, 'lint-failure') == 'true' }} || \
            ${{ contains(env.labels, 'test-failure') == 'true' }} \
          ]]; then
            echo "failures_detected=true" >> $GITHUB_OUTPUT
            echo "Failure labels detected."
          else
            echo "failures_detected=false" >> $GITHUB_OUTPUT
            echo "No failure labels detected."
          fi

      # # If test-passing label is present, ready_for_review=true
      # - name: Audit Test Passing Label
      #   id: audit_passing_labels
      #   if: |
      #     contains(github.event.pull_request.labels.*.name, 'test-passing')
      #   run: |
      #     echo "ready_for_review=true" >> $GITHUB_OUTPUT

  check-approvals:
    runs-on: ubuntu-latest
    needs: check-pr-status
    if: ${{ needs.check-pr-status.outputs.exempt == 'false' && needs.check-pr-status.outputs.draft == 'false' }}
    env:
      pr_number: ${{ needs.check-pr-status.outputs.pr_number }}
    outputs:
      approval_status: ${{ steps.verify_approval.outputs.approval_status }}
    steps:
      # - uses: actions/checkout@v4
      - name: Print vars (DELETE ME)
        run: |
          echo "exempt=${{ needs.check-pr-status.outputs.exempt }}"
          echo "draft=${{ needs.check-pr-status.outputs.draft }}"
          echo "failures_detected=${{ needs.check-pr-status.outputs.failures_detected }}"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          aws-access-key-id: ${{ secrets.aws_access_key_id }}
          aws-secret-access-key: ${{ secrets.aws_secret_access_key }}
          aws-region: "us-gov-west-1"

      - name: Get bot token from Parameter Store
        uses: marvinpinto/action-inject-ssm-secrets@latest
        with:
          ssm_parameter: /devops/VA_VSP_BOT_GITHUB_TOKEN
          env_variable_name: VA_VSP_BOT_GITHUB_TOKEN

      # If backend-review-group approval is required, get reviews
      - name: Get PR Reviews
        id: get_pr_reviews
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/pulls/${{ env.pr_number }}/reviews
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # If backend-review-group approval is required, get team members
      - name: Get backend-review-group members
        id: get_team_members
        uses: octokit/request-action@v2.x
        with:
          route: GET /orgs/department-of-veterans-affairs/teams/backend-review-group/members
        env:
          GITHUB_TOKEN: ${{ env.VA_VSP_BOT_GITHUB_TOKEN }}

      # If backend-review-group approval is required, confirm an approval exists from at least one BE team member
      - name: Verify backend-review-group approval
        id: verify_approval
        run: |
          BACKEND_REVIEWERS=$(cat <<'EOF' | jq -r '.[].login' | tr '\n' '|' | sed 's/|$//'
          ${{ steps.get_team_members.outputs.data }}
          EOF
          )

          APPROVALS=$(cat <<'EOF' | jq -r '.[] | select(.state == "APPROVED") | .user.login' | grep -iE "$BACKEND_REVIEWERS" | wc -l
          ${{ steps.get_pr_reviews.outputs.data }}
          EOF
          )

          echo "Number of backend-review-group approvals: $APPROVALS"
          if [ "$APPROVALS" -eq 0 ]; then
            echo "approval_status=required" >> $GITHUB_OUTPUT
            echo "Backend-review-group approval required."
          else
            echo "approval_status=confirmed" >> $GITHUB_OUTPUT
            echo "Backend-review-group approval confirmed."
          fi

  apply-labels:
    runs-on: ubuntu-latest
    needs: [check-pr-status, check-approvals]
    if: ${{ always() }}
    env:
      pr_number: ${{ needs.check-pr-status.outputs.pr_number }}
      pr_labels: ${{ needs.check-pr-status.outputs.pr_labels }}
      test_status: ${{ needs.check-pr-status.outputs.test_status }}
      exempt: ${{ needs.check-pr-status.outputs.exempt }}
      draft: ${{ needs.check-pr-status.outputs.draft }}
      failures_detected: ${{ needs.check-pr-status.outputs.failures_detected }}
      approval_status: ${{ needs.check-approvals.outputs.approval_status }}
    steps:
      - name: print vars (DELETE ME)
        id: print-vars
        run: |
          echo ${{ env.exempt }}
          echo ${{ env.draft }}
          echo ${{ env.failures_detected }}
          echo ${{ env.approval_status }}
          echo ${{ env.test_status }}

      # Remove labels if required
      - name: Remove require-backend-approval label
        if: ${{ (env.draft == 'true' || env.exempt == 'true') && contains(env.pr_labels, 'require-backend-approval') }}
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          number: ${{ env.pr_number }}
          labels: |
            require-backend-approval

      - name: Remove Review label
        uses: actions-ecosystem/action-remove-labels@v1
        if: |
          env.draft ||
          (
            contains(fromJSON(env.pr_labels), 'ready-for-backend-review') &&
            ( 
              env.failures_detected == 'true' ||
              env.approval_status == 'confirmed'
            )
          )
        with:
          number: ${{ env.pr_number }}
          labels: |
            ready-for-backend-review

      - name: Remove Test Passing label
        if: ${{ env.test_status == 'failure' && contains(fromJSON(env.pr_labels), 'test-passing') }}
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          number: ${{ env.pr_number }}
          labels: |
            test-passing

      - name: Remove Test Failure label
        if: ${{ env.test_status == 'success' && contains(fromJSON(env.pr_labels), 'test-passing') }}
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          number: ${{ env.pr_number }}
          labels: |
            test-failure

      # Add labels if required
      - name: Add require-backend-approval label
        if: ${{ env.draft == 'false' && env.exempt == 'false'}}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ env.pr_number }}
          labels: |
            require-backend-approval

      - name: Add Review label
        uses: actions-ecosystem/action-add-labels@v1
        if: |
          env.failures_detected == 'false' &&
          env.approval_status == 'required'
        with:
          number: ${{ env.pr_number }}
          labels: |
            ready-for-backend-review

      - name: Add Test Failure label
        if: ${{ env.test_status == 'failure' }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ env.pr_number }}
          labels: |
            test-failure

      - name: Add Test Passing label
        if: ${{ env.test_status == 'success' }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ env.pr_number }}
          labels: |
            test-passing
      
      - name: Debugging
        if: ${{ always() }}
        run: |
          echo "github_eventname: ${{ github.event_name }}"
          echo "github_event: ${{ toJSON(github.event) }}"
          echo "labels: ${{ toJSON(env.pr_labels) }}"
          echo "labels: ${{ env.pr_labels[0] }}"
          echo '${{ toJSON(github.event.workflow) }}' | jq .
