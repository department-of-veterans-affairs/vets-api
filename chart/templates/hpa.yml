{{- $root := . -}}
{{- range $name, $service := $root.Values.web.webServices }}
{{- if $service.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ $name }}
  namespace: {{ $root.Release.Namespace }}
spec:
  behavior:
    scaleUp:
      {{- if hasKey $service.autoscaling "scaleUp" }}
      stabilizationWindowSeconds: {{ $service.autoscaling.scaleUp.stabilizationWindowSeconds | default $root.Values.web.autoscaling.scaleUp.stabilizationWindowSeconds }}
      policies:
      - type: Pods
        value: {{ $service.autoscaling.scaleUp.pods | default $root.Values.web.autoscaling.scaleUp.pods }}
        periodSeconds: {{ $service.autoscaling.scaleUp.periodSeconds | default $root.Values.web.autoscaling.scaleUp.periodSeconds }}
      {{- else }}
      stabilizationWindowSeconds: {{ $root.Values.web.autoscaling.scaleUp.stabilizationWindowSeconds }}
      policies:
      - type: Pods
        value: {{ $root.Values.web.autoscaling.scaleUp.pods }}
        periodSeconds: {{ $root.Values.web.autoscaling.scaleUp.periodSeconds }}
      {{- end }}
    scaleDown:
      {{- if hasKey $service.autoscaling "scaleDown" }}
      stabilizationWindowSeconds: {{ $service.autoscaling.scaleDown.stabilizationWindowSeconds | default $root.Values.web.autoscaling.scaleDown.stabilizationWindowSeconds }}
      policies:
      - type: Pods
        value: {{ $service.autoscaling.scaleDown.pods | default $root.Values.web.autoscaling.scaleDown.pods }}
        periodSeconds: {{ $service.autoscaling.scaleDown.periodSeconds | default $root.Values.web.autoscaling.scaleDown.periodSeconds }}
      {{- else }}
      stabilizationWindowSeconds: {{ $root.Values.web.autoscaling.scaleDown.stabilizationWindowSeconds }}
      policies:
      - type: Pods
        value: {{ $root.Values.web.autoscaling.scaleDown.pods }}
        periodSeconds: {{ $root.Values.web.autoscaling.scaleDown.periodSeconds }}
      {{- end }}
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ $name }}
  minReplicas: {{ $service.autoscaling.minReplicas | default $root.Values.web.autoscaling.minReplicas }}
  maxReplicas: {{ $service.autoscaling.maxReplicas | default $root.Values.web.autoscaling.maxReplicas }}
  metrics:
  - type: External
    external:
      metric:
        name: "datadogmetric@{{ $root.Release.Namespace }}:puma-backlog-{{ $name }}"
      target:
        type: Value
        value: {{ $service.autoscaling.targetValue | default $root.Values.web.autoscaling.targetValue }}
{{- end }}
{{- end }}


{{- if .Values.worker.autoscaling.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Values.appName }}-sidekiq
spec:
  behavior:
    scaleUp:
      stabilizationWindowSeconds: {{ .Values.worker.autoscaling.scaleUp.stabilizationWindowSeconds }}
      policies:
      - type: Pods
        value: {{ .Values.worker.autoscaling.scaleUp.pods }}
        periodSeconds: {{ .Values.worker.autoscaling.scaleUp.periodSeconds }}
    scaleDown:
      stabilizationWindowSeconds: {{ .Values.worker.autoscaling.scaleDown.stabilizationWindowSeconds }}
      policies:
      - type: Pods
        value: {{ .Values.worker.autoscaling.scaleDown.pods }}
        periodSeconds: {{ .Values.worker.autoscaling.scaleDown.periodSeconds }}
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Values.appName }}-sidekiq
  minReplicas: {{ .Values.worker.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.worker.autoscaling.maxReplicas }}
  metrics:
  - type: External
    external:
      metric:
        name: "datadogmetric@{{ $root.Release.Namespace }}:sidekiq-utilization"
      target:
        type: Value
        value: {{ .Values.worker.autoscaling.targetValue }}
{{- end }}
