# Validates backend approval requirements for PRs
# Runs on PR updates and review submissions to ensure proper approval from backend-review-group
# or exemption through team-based file ownership
name: Backend Approval

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, converted_to_draft]
    branches: [master]
  pull_request_review:
    types: [submitted, dismissed]

permissions:
  id-token: write
  contents: read
  pull-requests: write

concurrency:
  group: backend-approval-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  # Teams exempt from backend approval when they exclusively own changed files
  EXEMPT_TEAMS: '["octo-identity", "lighthouse-dash", "lighthouse-pivot", "lighthouse-banana-peels", "mobile-api-team"]'
  AWS_REGION: us-gov-west-1
  SSM_BOT_TOKEN_PATH: /devops/VA_VSP_BOT_GITHUB_TOKEN

jobs:
  backend-approval-check:
    name: Succeed if backend approval is confirmed
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch PR data and changed files
        id: pr_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"

          # Fetch PR metadata
          PR_DATA=$(gh api /repos/${{ github.repository }}/pulls/${PR_NUMBER} --jq '{
            author: .user.login,
            draft: .draft,
            labels: [.labels[].name]
          }')

          echo "pr_author=$(echo "$PR_DATA" | jq -r '.author')" >> "$GITHUB_OUTPUT"
          echo "pr_draft=$(echo "$PR_DATA" | jq -r '.draft')" >> "$GITHUB_OUTPUT"
          echo "pr_labels=$(echo "$PR_DATA" | jq -c '.labels')" >> "$GITHUB_OUTPUT"

          # Fetch changed files (handles pagination automatically)
          CHANGED_FILES=$(gh api "/repos/${{ github.repository }}/pulls/${PR_NUMBER}/files" \
            --paginate --jq '.[].filename')

          echo "$CHANGED_FILES" > /tmp/changed_files.txt
          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)

          echo "file_count=${FILE_COUNT}" >> "$GITHUB_OUTPUT"

          echo "PR #${PR_NUMBER} Analysis"
          echo "  Author: $(echo "$PR_DATA" | jq -r '.author')"
          echo "  Draft: $(echo "$PR_DATA" | jq -r '.draft')"
          echo "  Changed files: ${FILE_COUNT}"

      - name: Analyze file ownership against CODEOWNERS
        id: file_ownership
        env:
          EXEMPT_TEAMS: ${{ env.EXEMPT_TEAMS }}
        run: |
          if [[ ! -s /tmp/changed_files.txt ]]; then
            echo "all_files_exempt=true" >> "$GITHUB_OUTPUT"
            echo "required_exempt_teams=" >> "$GITHUB_OUTPUT"
            echo "has_backend_owned_files=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CODEOWNERS_FILE=".github/CODEOWNERS"
          if [[ ! -f "$CODEOWNERS_FILE" ]]; then
            echo "[ERROR] CODEOWNERS file not found"
            echo "all_files_exempt=false" >> "$GITHUB_OUTPUT"
            echo "required_exempt_teams=" >> "$GITHUB_OUTPUT"
            echo "has_backend_owned_files=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          EXEMPT_TEAM_ARRAY=(
            "octo-identity"
            "lighthouse-dash"
            "lighthouse-pivot"
            "lighthouse-banana-peels"
            "mobile-api-team"
            "fed-eng-admin"
          )

          all_files_exempt=true
          has_backend_owned_files=false
          declare -A required_teams

          echo "Analyzing Code Owners"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          while IFS= read -r file || [[ -n "$file" ]]; do
            [[ -z "$file" ]] && continue

            echo "File: $file"

            result=$(awk -v f="$file" '
              $0 !~ /^#/ && NF > 0 {
                p = $1
                orig = p
                gsub(/\*\*\//, "<!DS!>", p)
                gsub(/\*/, "<!S!>", p)
                if (p ~ /\/$/) sub(/\/$/, "/<!S!>", p)
                else if (p !~ /<!S!>/ && p !~ /<!DS!>/ && p !~ /\./) p = "(" p "$|" p "/<!S!>)"
                gsub(/\./, "\\.", p)
                gsub(/<!DS!>/, ".*", p)
                gsub(/<!S!>/, ".*", p)
                if (f ~ "^" p) {
                  pattern = orig
                  owners = ""
                  for (i=2; i<=NF; i++) owners = owners $i " "
                }
              }
              END {
                if (pattern && owners) {
                  print pattern
                  print owners
                  exit 0
                }
                exit 1
              }
            ' "$CODEOWNERS_FILE")

            if [[ $? -ne 0 || -z "$result" ]]; then
              echo "  Pattern matched: (none)"
              echo "  Code owners: (none)"
              echo "  Status: [X] REQUIRES BACKEND APPROVAL"
              echo ""
              all_files_exempt=false
              has_backend_owned_files=true
              continue
            fi

            pattern=$(echo "$result" | head -1)
            owners=$(echo "$result" | tail -1)

            echo "  Pattern matched: \"$pattern\""
            echo "  Code owners: $owners"

            # Check if backend-review-group owns this file
            if echo "$owners" | grep -q "@department-of-veterans-affairs/backend-review-group"; then
              echo "  Status: [!] BACKEND-REVIEW-GROUP OWNER"
              has_backend_owned_files=true
              all_files_exempt=false
            fi

            # Check which exempt teams own this file
            file_has_exempt_owner=false
            for team in "${EXEMPT_TEAM_ARRAY[@]}"; do
              if echo "$owners" | grep -q "@department-of-veterans-affairs/${team}"; then
                echo "  Status: [OK] OWNED BY EXEMPT TEAM: $team"
                file_has_exempt_owner=true
                required_teams["$team"]=1
              fi
            done

            # If file has no exempt owner and no backend owner, backend approval needed
            if [[ "$file_has_exempt_owner" == "false" ]]; then
              if ! echo "$owners" | grep -q "@department-of-veterans-affairs/backend-review-group"; then
                echo "  Status: [X] REQUIRES BACKEND APPROVAL (no exempt/backend owner)"
                has_backend_owned_files=true
                all_files_exempt=false
              fi
            fi

            echo ""
          done < /tmp/changed_files.txt

          # Convert required teams to comma-separated string
          required_teams_list=$(printf "%s," "${!required_teams[@]}" | sed 's/,$//')

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Summary:"
          echo "  All files have exempt owners only: ${all_files_exempt}"
          echo "  Has backend-owned files: ${has_backend_owned_files}"
          echo "  Required exempt teams: ${required_teams_list:-none}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          echo "all_files_exempt=${all_files_exempt}" >> "$GITHUB_OUTPUT"
          echo "required_exempt_teams=${required_teams_list}" >> "$GITHUB_OUTPUT"
          echo "has_backend_owned_files=${has_backend_owned_files}" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_ASSUME_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      # VA_VSP_BOT_GITHUB_TOKEN is required to access organization team membership
      - name: Retrieve bot token from AWS SSM
        uses: marvinpinto/action-inject-ssm-secrets@latest
        with:
          ssm_parameter: ${{ env.SSM_BOT_TOKEN_PATH }}
          env_variable_name: VA_VSP_BOT_GITHUB_TOKEN

      - name: Determine approval status
        id: approval_status
        env:
          GITHUB_TOKEN: ${{ env.VA_VSP_BOT_GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
          ALL_FILES_EXEMPT: ${{ steps.file_ownership.outputs.all_files_exempt }}
          REQUIRED_EXEMPT_TEAMS: ${{ steps.file_ownership.outputs.required_exempt_teams }}
          HAS_BACKEND_OWNED_FILES: ${{ steps.file_ownership.outputs.has_backend_owned_files }}
        run: |
          backend_approved=false
          exempt_teams_approved=false
          missing_exempt_teams=""
          requires_approval=true

          echo "Determining approval requirements"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Get all current approvals (most recent per user)
          readarray -t ALL_APPROVERS < <(
            gh api /repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews --jq '
              [.[] | select(.state == "APPROVED")]
              | sort_by(.submitted_at)
              | reverse
              | unique_by(.user.login)
              | .[].user.login
            ' 2>/dev/null || true
          )

          echo "Current approvers: ${ALL_APPROVERS[*]}"
          echo ""

          # Check if backend-review-group approval is needed and present
          if [[ "${HAS_BACKEND_OWNED_FILES}" == "true" ]]; then
            echo "Checking for backend-review-group approval..."

            # Fetch backend-review-group members
            BACKEND_REVIEWERS=$(gh api /orgs/department-of-veterans-affairs/teams/backend-review-group/members --jq '.[].login')
            BACKEND_REVIEWERS=$(echo "$BACKEND_REVIEWERS" | tr '\n' '|' | sed 's/|$//')
            echo "  Backend reviewers: ${BACKEND_REVIEWERS}"

            # Check if any approver is from backend-review-group
            for approver in "${ALL_APPROVERS[@]}"; do
              if echo "$approver" | grep -iqE "^(${BACKEND_REVIEWERS})$"; then
                echo "[PASS] Backend approval confirmed by: ${approver}"
                backend_approved=true
                break
              fi
            done

            if [[ "${backend_approved}" == "false" ]]; then
              echo "[FAIL] No approval from backend-review-group"
            fi
            echo ""
          fi

          # Check if exempt teams approval is needed and present
          if [[ -n "${REQUIRED_EXEMPT_TEAMS}" ]]; then
            echo "Checking for exempt team approvals..."
            echo "Required exempt teams: ${REQUIRED_EXEMPT_TEAMS}"
            echo ""

            IFS=',' read -ra TEAMS <<< "${REQUIRED_EXEMPT_TEAMS}"
            all_exempt_teams_approved=true

            for team in "${TEAMS[@]}"; do
              echo "  Checking team: $team"

              # Fetch team members
              TEAM_MEMBERS=$(gh api /orgs/department-of-veterans-affairs/teams/${team}/members --jq '.[].login' 2>/dev/null || echo "")

              if [[ -z "$TEAM_MEMBERS" ]]; then
                echo "    [WARN] Could not fetch members for team: $team"
                continue
              fi

              TEAM_MEMBERS=$(echo "$TEAM_MEMBERS" | tr '\n' '|' | sed 's/|$//')
              echo "    Team members: ${TEAM_MEMBERS}"

              # Check if any approver is from this team
              team_approved=false
              for approver in "${ALL_APPROVERS[@]}"; do
                if echo "$approver" | grep -iqE "^(${TEAM_MEMBERS})$"; then
                  echo "    [PASS] Approved by: ${approver}"
                  team_approved=true
                  break
                fi
              done

              if [[ "${team_approved}" == "false" ]]; then
                echo "    [FAIL] No approval from team: $team"
                all_exempt_teams_approved=false
                missing_exempt_teams="${missing_exempt_teams}${team}, "
              fi
              echo ""
            done

            exempt_teams_approved=${all_exempt_teams_approved}
            missing_exempt_teams=$(echo "$missing_exempt_teams" | sed 's/, $//')
          else
            # No exempt teams required, mark as approved
            exempt_teams_approved=true
          fi

          # Determine final approval status
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Approval Status Summary:"
          echo "  Backend-owned files: ${HAS_BACKEND_OWNED_FILES}"
          echo "  Backend approved: ${backend_approved}"
          echo "  Required exempt teams: ${REQUIRED_EXEMPT_TEAMS:-none}"
          echo "  Exempt teams approved: ${exempt_teams_approved}"

          if [[ "${HAS_BACKEND_OWNED_FILES}" == "true" && "${backend_approved}" == "false" ]]; then
            requires_approval=true
            echo ""
            echo "[FAIL] Missing backend-review-group approval"
          elif [[ -n "${REQUIRED_EXEMPT_TEAMS}" && "${exempt_teams_approved}" == "false" ]]; then
            requires_approval=true
            echo ""
            echo "[FAIL] Missing approval from exempt teams: ${missing_exempt_teams}"
          else
            requires_approval=false
            echo ""
            echo "[PASS] All required approvals received"
          fi
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Output results for subsequent steps
          echo "backend_approved=${backend_approved}" >> "$GITHUB_OUTPUT"
          echo "exempt_teams_approved=${exempt_teams_approved}" >> "$GITHUB_OUTPUT"
          echo "requires_approval=${requires_approval}" >> "$GITHUB_OUTPUT"
          echo "missing_exempt_teams=${missing_exempt_teams}" >> "$GITHUB_OUTPUT"

      - name: Update PR labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
          HAS_BACKEND_OWNED_FILES: ${{ steps.file_ownership.outputs.has_backend_owned_files }}
          REQUIRED_EXEMPT_TEAMS: ${{ steps.file_ownership.outputs.required_exempt_teams }}
          REQUIRES_APPROVAL: ${{ steps.approval_status.outputs.requires_approval }}
        run: |
          echo "Updating PR labels..."

          # Determine which labels to add/remove based on status
          LABELS_TO_ADD=()
          LABELS_TO_REMOVE=()

          # Handle backend approval label
          if [[ "${HAS_BACKEND_OWNED_FILES}" == "true" ]]; then
            if [[ "${REQUIRES_APPROVAL}" == "true" ]]; then
              LABELS_TO_ADD+=("require-backend-approval")
            else
              LABELS_TO_REMOVE+=("require-backend-approval")
            fi
          else
            LABELS_TO_REMOVE+=("require-backend-approval")
          fi

          # Handle exempt team labels
          if [[ -n "${REQUIRED_EXEMPT_TEAMS}" ]]; then
            if [[ "${REQUIRES_APPROVAL}" == "true" ]]; then
              LABELS_TO_ADD+=("require-team-approval")
            else
              LABELS_TO_ADD+=("team-approved")
              LABELS_TO_REMOVE+=("require-team-approval")
            fi
          fi

          # Apply label changes
          for label in "${LABELS_TO_REMOVE[@]}"; do
            echo "  Removing: ${label}"
            gh pr edit "${PR_NUMBER}" --remove-label "${label}" 2>/dev/null || echo "  [WARN] Could not remove ${label}"
          done

          for label in "${LABELS_TO_ADD[@]}"; do
            echo "  Adding: ${label}"
            gh pr edit "${PR_NUMBER}" --add-label "${label}" 2>/dev/null || echo "  [WARN] Could not add ${label}"
          done

      - name: Fail if approval required
        if: steps.approval_status.outputs.requires_approval == 'true'
        env:
          HAS_BACKEND_OWNED_FILES: ${{ steps.file_ownership.outputs.has_backend_owned_files }}
          REQUIRED_EXEMPT_TEAMS: ${{ steps.file_ownership.outputs.required_exempt_teams }}
          BACKEND_APPROVED: ${{ steps.approval_status.outputs.backend_approved }}
          EXEMPT_TEAMS_APPROVED: ${{ steps.approval_status.outputs.exempt_teams_approved }}
          MISSING_EXEMPT_TEAMS: ${{ steps.approval_status.outputs.missing_exempt_teams }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "[FAIL] REQUIRED APPROVALS MISSING"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          if [[ "${HAS_BACKEND_OWNED_FILES}" == "true" && "${BACKEND_APPROVED}" == "false" ]]; then
            echo "❌ This PR requires approval from backend-review-group"
            echo ""
          fi

          if [[ -n "${REQUIRED_EXEMPT_TEAMS}" && "${EXEMPT_TEAMS_APPROVED}" == "false" ]]; then
            echo "❌ This PR requires approval from the following team(s):"
            echo "   ${MISSING_EXEMPT_TEAMS}"
            echo ""
            echo "These teams own files in this PR and must review the changes."
            echo ""
          fi

          echo "To resolve:"
          echo "  • Request review from the required team(s)"
          echo "  • Ensure team members with proper access approve the PR"
          echo "  • Both backend-review-group AND exempt team approvals are required"
          echo "    when files are owned by both"
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          exit 1

      - name: Confirm approval success
        if: steps.approval_status.outputs.requires_approval == 'false'
        env:
          BACKEND_APPROVED: ${{ steps.approval_status.outputs.backend_approved }}
          EXEMPT_TEAMS_APPROVED: ${{ steps.approval_status.outputs.exempt_teams_approved }}
          REQUIRED_EXEMPT_TEAMS: ${{ steps.file_ownership.outputs.required_exempt_teams }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "[PASS] ALL REQUIRED APPROVALS RECEIVED"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          if [[ "${BACKEND_APPROVED}" == "true" ]]; then
            echo "✓ Backend-review-group approval: confirmed"
          fi

          if [[ -n "${REQUIRED_EXEMPT_TEAMS}" ]]; then
            echo "✓ Exempt team approvals: confirmed"
            echo "  Teams: ${REQUIRED_EXEMPT_TEAMS}"
          fi

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          exit 0
