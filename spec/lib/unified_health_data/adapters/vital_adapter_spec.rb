# frozen_string_literal: true

require 'rails_helper'
require 'unified_health_data/adapters/vital_adapter'
require 'unified_health_data/models/vital'

RSpec.describe 'VitalAdapter' do
  let(:adapter) { UnifiedHealthData::Adapters::VitalAdapter.new }
  let(:vital_sample_response) do
    JSON.parse(Rails.root.join(
      'spec', 'fixtures', 'unified_health_data', 'vitals_example.json'
    ).read)
  end

  before do
    allow(UnifiedHealthData::Vital).to receive(:new).and_call_original
    allow(Rails.logger).to receive(:warn)
  end

  describe '#parse_single_vital' do
    describe 'formatting blood pressure' do
      it 'returns the expected fields for VistA blood pressure record' do
        record = vital_sample_response['vista']['entry'][5]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'ab512a04-f9d6-4100-972c-6a5364451c54',
            'name' => 'Blood pressure',
            'type' => 'BLOOD_PRESSURE',
            'date' => '2024-12-17T16:03:16Z',
            'measurement' => '112/80',
            'location' => 'GREELEY NUTRITION',
            'notes' => []
          }
        )
      end

      it 'returns the expected fields for OH blood pressure record' do
        record = vital_sample_response['oracle-health']['entry'][6]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'BP-15249666629-15249666631',
            'name' => 'Blood pressure',
            'type' => 'BLOOD_PRESSURE',
            'date' => '2025-07-24T18:23:00.000Z',
            'measurement' => '112/80',
            'location' => '668 Green Primary Care',
            'notes' => []
          }
        )
      end
    end

    describe 'formatting height' do
      it 'returns the expected fields for VistA height record' do
        record = vital_sample_response['vista']['entry'][2]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => '3f951c1d-406f-44e0-a922-bf6db786e652',
            'name' => 'Height',
            'type' => 'HEIGHT',
            'date' => '2024-12-05T16:24:26Z',
            'measurement' => '5 feet, 5.0 inches',
            'location' => 'BAYPINES',
            'notes' => []
          }
        )
      end

      it 'returns the expected fields for OH height record' do
        record = vital_sample_response['oracle-health']['entry'][7]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'VS-15249666623',
            'name' => 'Height/length measured',
            'type' => 'HEIGHT',
            'date' => '2025-07-24T18:23:00.000Z',
            'measurement' => '5 feet, 4.6 inches',
            'location' => '668 Green Primary Care',
            'notes' => []
          }
        )
      end
    end

    describe 'formatting temperature' do
      it 'returns the expected fields for VistA temperature record' do
        record = vital_sample_response['vista']['entry'][4]
        parsed_vital = adapter.parse_single_vital(record)
        expect(parsed_vital).to have_attributes(
          {
            'id' => 'fa104e74-21b5-4ee0-9e15-0f391093aaa7',
            'name' => 'Temperature',
            'type' => 'TEMPERATURE',
            'date' => '2025-01-29T14:56:17Z',
            'measurement' => '113.0 Â°F',
            'location' => 'CHYTEST PRO',
            'notes' => []
          }
        )
      end

      it 'returns the expected fields for OH temperature record' do
        record = vital_sample_response['oracle-health']['entry'][3]
        parsed_vital = adapter.parse_single_vital(record)
        expect(parsed_vital).to have_attributes(
          {
            'id' => 'VS-15249666641',
            'name' => 'Temperature tympanic',
            'type' => 'TEMPERATURE',
            'date' => '2025-07-24T18:23:00.000Z',
            'measurement' => '98.8 Â°F',
            'location' => '668 Green Primary Care',
            'notes' => []
          }
        )
      end
    end

    describe 'formatting weight' do
      it 'returns the expected fields for record with multiple weight measurements (and notes)' do
        record = vital_sample_response['oracle-health']['entry'][2]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'VS-15249708684',
            'name' => 'Weight dosing',
            'type' => 'WEIGHT',
            'date' => '2025-07-24T18:23:00.000Z',
            'measurement' => '150.796 pounds',
            'location' => '668 Green Primary Care',
            'notes' => ['Result generated by automated process based on measured weight.']
          }
        )
      end

      it 'returns the expected fields for VistA weight record' do
        record = vital_sample_response['vista']['entry'][0]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'be3724c0-f9e2-4e6a-b37e-366aca305613',
            'name' => 'Weight',
            'type' => 'WEIGHT',
            'date' => '2025-08-22T22:16:24Z',
            'measurement' => '165.35 pounds',
            'location' => 'CHY ANOTHER TEST CLINIC',
            'notes' => []
          }
        )
      end
    end

    describe 'formatting pulse' do
      it 'returns the expected fields for VistA pulse record' do
        record = vital_sample_response['vista']['entry'][3]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'bbf83fa7-db79-4139-b78d-bbfcf48c5eae',
            'name' => 'Pulse',
            'type' => 'PULSE',
            'date' => '2025-01-29T14:56:17Z',
            'measurement' => '80 beats per minute',
            'location' => 'CHYTEST PRO',
            'notes' => []
          }
        )
      end

      it 'returns the expected fields for OH pulse record' do
        record = vital_sample_response['oracle-health']['entry'][5]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'VS-15249666635',
            'name' => 'Peripheral pulse rate',
            'type' => 'PULSE',
            'date' => '2025-07-24T18:23:00.000Z',
            'measurement' => '87 beats per minute',
            'location' => '668 Green Primary Care',
            'notes' => []
          }
        )
      end
    end

    describe 'formatting pulse oximetry' do
      it 'returns the expected fields for VistA pulse oximetry record' do
        record = vital_sample_response['vista']['entry'][6]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => '5751a572-5e53-44d8-8c29-d7d1477d31aa',
            'name' => 'Pulse oximetry',
            'type' => 'PULSE_OXIMETRY',
            'date' => '2024-12-17T16:03:16Z',
            'measurement' => '97%',
            'location' => 'GREELEY NUTRITION',
            'notes' => []
          }
        )
      end

      it 'returns the expected fields for OH pulse oximetry record' do
        record = vital_sample_response['oracle-health']['entry'][1]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'VS-PO-15249666639',
            'name' => 'Spo2',
            'type' => 'PULSE_OXIMETRY',
            'date' => '2025-07-24T18:23:00.000Z',
            'measurement' => '99%',
            'location' => '668 Green Primary Care',
            'notes' => []
          }
        )
      end
    end

    describe 'formatting respiration rate' do
      it 'returns the expected fields for VistA respiration record' do
        record = vital_sample_response['vista']['entry'][7]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'a3356389-2d2d-409d-bf0f-5da95229012e',
            'name' => 'Respiration',
            'type' => 'RESPIRATION',
            'date' => '2024-12-17T16:03:16Z',
            'measurement' => '18 breaths per minute',
            'location' => 'GREELEY NUTRITION',
            'notes' => []
          }
        )
      end

      it 'returns the expected fields for OH respiration record' do
        record = vital_sample_response['oracle-health']['entry'][4]
        parsed_vital = adapter.parse_single_vital(record)

        expect(parsed_vital).to have_attributes(
          {
            'id' => 'VS-15249666637',
            'name' => 'Respiratory rate',
            'type' => 'RESPIRATION',
            'date' => '2025-07-24T18:23:00.000Z',
            'measurement' => '19 breaths per minute',
            'location' => '668 Green Primary Care',
            'notes' => []
          }
        )
      end
    end

    describe 'logging unknown LOINC codes' do
      it 'logs a warning when a vital record has an unknown LOINC code but still parses record' do
        record = {
          'resource' => {
            'resourceType' => 'Observation',
            'id' => 'a3356389-2d2d-409d-bf0f-5da95229012e',
            'contained' => [
              {
                'resourceType' => 'Location',
                'id' => 'location-873',
                'name' => 'GREELEY NUTRITION'
              }
            ],
            'code' => {
              'coding' => [
                { 'system' => 'http://loinc.org', 'code' => '12345-0', 'display' => 'Unknown Vital' }
              ],
              'text' => 'Unknown Vital Measurement'
            },
            'effectiveDateTime' => '2024-12-17T16:03:16Z',
            'performer' => [
              {
                'extension' => [
                  {
                    'url' => 'http://hl7.org/fhir/StructureDefinition/alternate-reference',
                    'valueReference' => {
                      'reference' => '#location-873'
                    }
                  }
                ],
                'display' => 'Location 873'
              }
            ],
            'valueQuantity' => {
              'value' => 18,
              'unit' => '/min',
              'system' => 'http://unitsofmeasure.org',
              'code' => '/min'
            }
          }
        }

        expect(Rails.logger).to receive(:warn).with(/\["code: 12345-0, display: Unknown Vital"\]/i)

        parsed_vital = adapter.parse_single_vital(record)
        expect(parsed_vital).to have_attributes(
          {
            'id' => 'a3356389-2d2d-409d-bf0f-5da95229012e',
            'name' => 'Unknown vital measurement',
            'type' => 'OTHER',
            'date' => '2024-12-17T16:03:16Z',
            'measurement' => '18',
            'location' => 'GREELEY NUTRITION',
            'notes' => []
          }
        )
      end

      it 'logs a warning when a vital record has an missing LOINC code but parses is available' do
        record = {
          'resource' => {
            'resourceType' => 'Observation',
            'id' => '12345',
            'code' => {
              'coding' => [],
              'text' => 'Missing vital measurement'
            },
            'valueQuantity' => {
              'value' => 18,
              'unit' => '/min',
              'system' => 'http://unitsofmeasure.org',
              'code' => '/min'
            }
          }
        }

        expect(Rails.logger).to receive(:warn).with(
          /Missing vital measurement/i
        )

        parsed_vital = adapter.parse_single_vital(record)
        expect(parsed_vital).to have_attributes(
          {
            'id' => '12345',
            'name' => 'Missing vital measurement',
            'type' => 'OTHER',
            'date' => nil,
            'measurement' => '18',
            'location' => nil,
            'notes' => []
          }
        )
      end
    end
  end
end
