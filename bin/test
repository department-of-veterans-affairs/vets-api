#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib/vets-api/commands/test'
require 'rake'

VALID_OPTIONS = ['--no-parallel', '--coverage', '--verbose']

invalid_options = ARGV.select { |o| o.start_with?('--', '-') && !VALID_OPTIONS.include?(o) }

if ARGV.include?('--help') || ARGV.include?('-h')
  puts <<~HELP
    Usage:
      bin/test [options] [files|folders]

    Options:
      --help, -h            Display help message for 'setup'
      --ci                  Run the tests exactly like the CI (requires docker)
      --no-parallel         Run the tests in parallel
      --coverage            Include test coverage report
      --verbose             Output all logs including info and warning

    Examples:
      bin/test spec modules
      bin/test --no-parallel spec/models/account_spec.rb
      bin/test spec/models/account_spec.rb
      bin/test --no-parallel --only-failures spec/models/account_spec.rb
      bin/test --CI

    Defaults:
      - Only run tests in './spec' folder
      - Run in parallel
      - No coverage
      - Output only pending and failures
  HELP
elsif ARGV.include?('--ci')
  puts "WARNING: --ci ignores all other options and inputs"
  system('bin/test_ci')
elsif invalid_options.empty?
  VetsApi::Commands::Test.run(ARGV)
else
  puts "Invalid option(s) found: #{invalid_options.join(', ')}. Use \"--help\" for usage information."
end
