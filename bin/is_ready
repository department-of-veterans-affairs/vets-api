#!/usr/bin/env bash

# Uses the percentage of total pool_capacity to total max_threads to determine
# readiness (e.g. "90" means 90% of pods are available/unused).
#
# If the percentage is >= threshold, script will exit with a success (0) and
# pod is considered ready for traffic. If the percentage is < threshold, script
# will exit with a failure (1) and the probe will fail.

THRESHOLD=25

data=$(curl -s 127.0.0.1:9293/stats)

if [ $? -ne 0 ] || [ -z "$data" ]; then
	echo "Failed to get a valid response from the server. Is Puma Stats app running?"
	exit 1
fi

# Check if BACKLOG_POD is set to true and exit 0 if it is. A BACKLOG_POD will
# accumulate a backlog intentinally so that it's not possible for all pods to
# be unavailable in a traffic surge.
if [ "$BACKLOG_POD" = "true" ]; then
	echo "BACKLOG_POD is set to true. Exiting with success."
	exit 0
fi

pool_capacity=$(echo "$data" | grep -oE '"pool_capacity":[0-9]+' | cut -f2 -d: | awk '{sum+=$1} END {print sum}')
max_threads=$(echo "$data" | grep -oE '"max_threads":[0-9]+' | cut -f2 -d: | awk '{sum+=$1} END {print sum}')

percentage=$(awk "BEGIN {printf \"%d\", ($pool_capacity * 100) / $max_threads}")

exit $((percentage >= THRESHOLD ? 0 : 1))
