{{- $root := . -}}
{{- range $name, $service := $root.Values.web.webServices }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: terminal-auditing
  labels:
    app:  {{ $name }}
data:
  exec-proxy.sh: |
    #!/bin/bash
    # /usr/local/bin/exec-proxy.sh
    # Read the ArgoCD/Dex username from an annotation or env var
    # For ArgoCD UI, you can inject this into the pod via annotation

    CONSOLE_USER="${ARGOCD_USERNAME:-unknown}"

    # Target container inside the pod
    TARGET_CONTAINER="${TARGET_CONTAINER:-rails}"

    # Default to launching Rails console
    # CONSOLE_CMD="${*:-bundle exec rails console}"

    # Execute the command inside the Rails container with CONSOLE_USER set
    # exec kubectl exec -it "$HOSTNAME" -c "$TARGET_CONTAINER" -- env CONSOLE_USER="$CONSOLE_USER" $CONSOLE_CMD
{{- end }}
