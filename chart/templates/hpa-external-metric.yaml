{{- $root := . -}}
{{- range $name, $service := $root.Values.web.webServices }}
{{- if $service.autoscaling.enabled }}
{{- $pool := "min:puma.pool_capacity{kube_cluster_name:dsva-vagov-" }}
{{- $threads := "avg:puma.max_threads{kube_cluster_name:dsva-vagov-" }}
{{- $deployment := "-cluster,kube_deployment:" }}

---
apiVersion: datadoghq.com/v1alpha1
kind: DatadogMetric
metadata:
  name: puma-backlog-{{ $name }}
  namespace: {{ $root.Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/sync-wave: "-1"
spec:
  query: (({{ $threads }}{{ $root.Values.target_env }}{{ $deployment}}{{ $name }}} - {{ $pool }}{{ $root.Values.target_env }}{{ $deployment}}{{ $name }}}) / {{ $threads }}{{ $root.Values.target_env }}{{ $deployment}}{{ $name }}})*100

{{- end }}
{{- end }}

{{- if .Values.worker.autoscaling.enabled }}
---
apiVersion: datadoghq.com/v1alpha1
kind: DatadogMetric
metadata:
  name: sidekiq-enqueued-jobs
  namespace: {{ $root.Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/sync-wave: "-1"
spec:
  query: avg:sidekiq.enqueued{env:eks-{{ .Values.target_env }}}
{{- end }}


