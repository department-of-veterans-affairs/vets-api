name: Settings Checks

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - 'config/settings.yml'
      - 'config/settings/*.yml'
permissions:
  id-token: write
  contents: read
  checks: write

jobs:
  validate-config-files:
    env:
      COVERBAND_DISABLE_AUTO_START: true
      BUNDLE_ENTERPRISE__CONTRIBSYS__COM: ${{ secrets.BUNDLE_ENTERPRISE__CONTRIBSYS__COM }}
    permissions: write-all
    runs-on: ubuntu-32-cores-latest
    steps:
      - uses: actions/checkout@v5

      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Install pdftk
        run: sudo apt-get update && sudo apt-get install -y pdftk-java

      - name: Run Settings Validation Rake task
        run: bundle exec rake settings:validate

      - name: Add Settings Failure label
        if: failure() && github.event_name == 'pull_request'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ github.event.pull_request.number }}
          labels: settings-failure

      - name: Remove Settings Failure label
        if: success() && github.event_name == 'pull_request'
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          number: ${{ github.event.pull_request.number }}
          labels: settings-failure

  check-parameters:
    runs-on: ubuntu-32-cores-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_ASSUME_ROLE }}
          aws-region: us-gov-west-1

      - name: Obtain GitHub Token
        uses: department-of-veterans-affairs/action-inject-ssm-secrets@d8e6de3bde4dd728c9d732baef58b3c854b8c4bb # latest
        with:
          ssm_parameter: /devops/VA_VSP_BOT_GITHUB_TOKEN
          env_variable_name: VA_VSP_BOT_GITHUB_TOKEN

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch the remote master branch
        run: git fetch origin master

      - name: Check ENV variables for Parameter Store validation
        run: |
          # Exit early if no changes to settings.yml
          diff_output=$(git diff origin/master config/settings.yml)
          if [[ -z "$diff_output" ]]; then
            echo "No changes detected in config/settings.yml."
            exit 0
          fi

          # Extract ENV variable keys from the diff
          new_env_keys=$(git diff --unified=0 origin/master config/settings.yml | \
            grep '^+' | grep -o 'ENV\[[^]]*\]' | sed 's/ENV\[\([^]]*\)\]/\1/' | tr -d "'" | sort -u)

          # Exit early if no ENV variables found
          if [[ -z "$new_env_keys" ]]; then
            echo "No ENV variables found in changes."
            exit 0
          fi

          # Set flag indicating ENV variables were found
          echo "HAS_ENV_VARS=true" >> $GITHUB_ENV

          echo "Found ENV keys to validate:"
          echo "$new_env_keys" | sed 's/^/  - /'

          # Validate each ENV key against Parameter Store
          invalid_parameters=()
          while IFS= read -r key; do
            [[ -z "$key" ]] && continue

            # Format key for Parameter Store path
            formatted_key=$(echo "$key" | sed 's/__/\//g')
            echo "Processing: $key (formatted as: $formatted_key)"

            # Build parameter names for all environments
            base_path="/dsva-vagov/vets-api"
            param_names=(
              "$base_path/dev/env_vars/$formatted_key"
              "$base_path/staging/env_vars/$formatted_key"
              "$base_path/sandbox/env_vars/$formatted_key"
              "$base_path/prod/env_vars/$formatted_key"
            )

            # Query Parameter Store
            set +e
            ssm_output=$(aws ssm get-parameters \
              --names "${param_names[@]}" \
              --query "InvalidParameters" \
              --output json 2>&1)
            aws_exit_code=$?
            set -e

            if [ $aws_exit_code -ne 0 ]; then
              echo "AWS SSM command failed: $ssm_output"
              continue
            fi

            # Collect invalid parameters
            if [[ -n "$ssm_output" && "$ssm_output" != "[]" && "$ssm_output" != "null" ]]; then
              while IFS= read -r param; do
                [[ -n "$param" ]] && invalid_parameters+=("$param")
              done < <(echo "$ssm_output" | jq -r '.[]' 2>/dev/null || true)
            fi
          done <<< "$new_env_keys"

          # Export results
          if [[ ${#invalid_parameters[@]} -gt 0 ]]; then
            echo "Found ${#invalid_parameters[@]} invalid parameter(s):"
            printf '  - %s\n' "${invalid_parameters[@]}"

            {
              echo "INVALID_PARAMETERS<<EOF"
              printf -- '- %s\n' "${invalid_parameters[@]}"
              echo "EOF"
            } >> "$GITHUB_ENV"
          else
            echo "All parameters are valid"
            echo "INVALID_PARAMETERS=" >> $GITHUB_ENV
          fi

      - name: Comment on PR with validation results
        if: env.HAS_ENV_VARS == 'true'
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        with:
          message: |
            ${{ env.INVALID_PARAMETERS != '' && ':warning: The following Parameter Store values are invalid. Please make sure the values are correct and exist in AWS Parameter Store before merging:' || ':+1: All Parameter Store values in this PR are valid' }}
            ${{ env.INVALID_PARAMETERS }}
          github-token: ${{ env.VA_VSP_BOT_GITHUB_TOKEN }}

      - name: Fail if invalid parameters are found
        if: env.INVALID_PARAMETERS != ''
        run: exit 1
