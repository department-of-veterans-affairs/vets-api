{{- $root := . -}}
{{- range $name, $service := $root.Values.web.webServices }}
{{- if $service.autoscaling.enabled }}
{{- $pool := "avg:puma.pool_capacity{kube_cluster_name:dsva-vagov-" }}
{{- $threads := "avg:puma.max_threads{kube_cluster_name:dsva-vagov-" }}
{{- $replicas_available := "sum:kubernetes_state.deployment.replicas_available{kube_cluster_name:dsva-vagov-" }}
{{- $deployment := "-cluster,kube_deployment:" }}

---
apiVersion: datadoghq.com/v1alpha1
kind: DatadogMetric
metadata:
  name: puma-backlog-{{ $name }}
  namespace: {{ $root.Release.Namespace }}
spec:
	query: ((({{ $threads }}{{ $root.Values.target_env }}{{ $deployment}}{{ $name }}}*{{ $replicas_available }}{{ $root.Values.target_env }}{{ $deployment}}{{ $name }}) - {{ $pool }}{{ $root.Values.target_env }}{{ $deployment}}{{ $name }}}) / ({{ $threads }}{{ $root.Values.target_env }}{{ $deployment}}{{ $name }}}*{{ $replicas_available }}{{ $root.Values.target_env }}{{ $deployment}}{{ $name }}}))*100
{{- end }}
{{- end }}

{{- if .Values.worker.autoscaling.enabled }}
{{- $sidekiq_busy := "max:sidekiq.busy{kube_cluster_name:dsva-vagov-" }}
{{- $sidekiq_processes := "max:kubernetes_state.deployment.replicas_available{kube_cluster_name:dsva-vagov-" }}
{{- $deployment := "-cluster,kube_deployment:" }}
{{- $threads := "" }}
{{- range .Values.worker.envSecrets }}
  {{- if eq .name "RAILS_MAX_THREADS" }}
    {{- $threads = .value }}
  {{- end }}
{{- end }}
---
apiVersion: datadoghq.com/v1alpha1
kind: DatadogMetric
metadata:
  name: sidekiq-utilization
  namespace: {{ $root.Release.Namespace }}
spec:
  query: ({{ $sidekiq_busy }}{{ $root.Values.target_env }}{{ $deployment}}vets-api-sidekiq} / ({{ $sidekiq_processes }}{{ $root.Values.target_env }}{{ $deployment }}vets-api-sidekiq}*{{ $threads }})*100)
{{- end }}
