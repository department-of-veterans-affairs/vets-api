name: Clean Up Old GitHub Environments

on:
  push:
    branches:
      - eb-cleanup-gh-env
  schedule:
    - cron: '0 0 * * 1-5' # Weekdays at midnight UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch and Filter Old Environments
        if: steps.restore-cache.outputs.cache-hit != 'true'
        id: fetch-and-filter
        run: |
          NOW=$(date +%s)
          THRESHOLD=$((90 * 24 * 60 * 60)) # 90 days in seconds
          PAGE=1

          echo "[]" > all-environments.json
          echo -n "Fetching all environments..."

          while true; do
            echo -n "."
            RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/environments?per_page=100&page=$PAGE")

            if [ "$(echo "$RESPONSE" | jq '.environments | length')" -eq 0 ]; then
              break
            fi

            jq -s '.[0] + .[1]' all-environments.json <(echo "$RESPONSE" | jq '.environments') > temp.json
            mv temp.json all-environments.json
            PAGE=$((PAGE + 1))
          done

          echo

          echo "Filtering old environments..."
          jq -r \
            --arg now "$NOW" \
            --arg threshold "$THRESHOLD" '
              .[] |
              select((.protection_rules | length) == 0) |
              select((now | tonumber) - (.created_at | fromdateiso8601 | tonumber) > ($threshold | tonumber)) |
              .name | @uri
            ' all-environments.json > delete-list.txt

          echo "Filtered environments saved to delete-list.txt:"
          cat delete-list.txt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.aws_access_key_id }}
          aws-secret-access-key: ${{ secrets.aws_secret_access_key }}
          aws-region: "us-gov-west-1"

      - name: Get Bot Token from Parameter Store
        uses: marvinpinto/action-inject-ssm-secrets@latest
        with:
          ssm_parameter: /devops/VA_VSP_BOT_GITHUB_TOKEN
          env_variable_name: VA_VSP_BOT_GITHUB_TOKEN

      - name: Delete Old Environments
        if: success()
        run: |
          while IFS= read -r environment; do
            echo "Deleting $environment..."
            curl -X DELETE -s -H "Authorization: Bearer ${{ env.VA_VSP_BOT_GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/environments/$environment"
          done < delete-list.txt
