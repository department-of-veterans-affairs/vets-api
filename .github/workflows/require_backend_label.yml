name: Label Pull Request Reviewers
on:
  pull_request:
    # types: [review_requested, review_request_removed, ready_for_review, unlabeled]
    types: [opened, synchronize, review_requested, review_request_removed, ready_for_review, unlabeled]

jobs:
  check-requested-teams:
    runs-on: ubuntu-latest
    if: |
        (
          contains(toJSON(github.event.pull_request.requested_teams), '"mobile"') ||
          contains(toJSON(github.event.pull_request.requested_teams.*.name), 'lighthouse') ||
          contains(toJSON(github.event.pull_request.requested_teams.*.name), 'identity')
        )
    outputs:
      omitted_team_found: ${{ steps.set-output.outputs.omitted_team_found }}

    steps:
      - name: Set Output if Team Found
        id: set-output
        run: echo "omitted_team_found=true"

  set-skip-status:
    runs-on: ubuntu-latest
    needs: check-requested-teams
    outputs:
      team_check_skipped: ${{ job.status == 'skipped' && 'true' || 'false' }}

    steps:
      - name: Set Skip Status Output
        run: echo "Team check job status: ${{ job.status }}"

  handle-output:
    runs-on: ubuntu-latest
    needs: check-requested-teams
    steps:
      - name: Assign team approval
        id: assign_approval_team
        run: |
          if [ "${{ needs.check-requested-teams.outputs.omitted_team_found || 'false' }}" == "true" ]; then
            echo "Omitted teams found."
            echo "backend_approval_required=false" >> $GITHUB_OUTPUT
          else
            echo "backend_approval_required=true" >> $GITHUB_OUTPUT
            echo "Backend Review required"."
          fi

      - name: Add omit-backend-approval label
        if: steps.assign_approval_team.outputs.backend_approval_required == 'false'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ github.event.pull_request.number }}
          labels: |
            omit-backend-approval

      - name: Remove require-backend-approval label
        if: steps.assign_approval_team.outputs.backend_approval_required == 'false'
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          number: ${{ github.event.pull_request.number }}
          labels: |
            require-backend-approval

      - name: Add require-backend-approval label
        if: steps.assign_approval_team.outputs.backend_approval_required == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ github.event.pull_request.number }}
          labels: |
            require-backend-approval

      - name: Remove omit-backend-approval label
        if: steps.assign_approval_team.outputs.backend_approval_required == 'true'
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          number: ${{ github.event.pull_request.number }}
          labels: |
            omit-backend-approval

