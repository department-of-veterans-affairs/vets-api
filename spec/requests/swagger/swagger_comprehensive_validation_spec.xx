# spec/requests/swagger/swagger_comprehensive_validation_spec.rb
require 'rails_helper'

RSpec.describe 'Comprehensive API Validation', order: :defined, type: %i[apivore request] do
  include AuthenticatedSessionHelper

  subject { Apivore::SwaggerChecker.instance_for('/v0/apidocs.json') }

  before do
    allow(HealthCareApplication).to receive(:user_icn).and_return('123')
  end

  it 'tests all documented routes' do
    # exclude these route as they return binaries
    subject.untested_mappings.delete('/v0/letters/{id}')
    subject.untested_mappings.delete('/debts_api/v0/financial_status_reports/download_pdf')
    subject.untested_mappings.delete('/v0/form1095_bs/download_pdf/{tax_year}')
    subject.untested_mappings.delete('/v0/form1095_bs/download_txt/{tax_year}')
    subject.untested_mappings.delete('/v0/claim_letters/{document_id}')
    subject.untested_mappings.delete('/v0/coe/download_coe')
    subject.untested_mappings.delete('/v0/coe/document_download/{id}')
    subject.untested_mappings.delete('/v0/caregivers_assistance_claims/download_pdf')
    subject.untested_mappings.delete('/v0/health_care_applications/download_pdf')
    subject.untested_mappings.delete('/v0/form0969')
    subject.untested_mappings.delete('/travel_pay/v0/claims/{claimId}/documents/{docId}')

    # SiS methods that involve forms & redirects
    subject.untested_mappings.delete('/v0/sign_in/authorize')
    subject.untested_mappings.delete('/v0/sign_in/callback')
    subject.untested_mappings.delete('/v0/sign_in/logout')

    expect(subject).to validate_all_paths
  end
end
