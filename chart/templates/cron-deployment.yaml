{{- $root := . -}}
{{- range $name, $cronJob := $root.Values.cronJobs }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $name }}
  namespace: {{ $root.Release.Namespace }}
spec:
  schedule: "{{ $cronJob.schedule }}"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      parallelism: 1
      completions: 1
      backoffLimit: 1
      template:
        spec:
          containers:
            - name: {{ $name }}
              image: "{{ $root.Values.image.value }}:{{ $root.Values.image.tag }}"
              imagePullPolicy: {{ $cronJob.imagePullPolicy | default $root.Values.image.pullPolicy }}
              command:
{{ toYaml $cronJob.command | indent 16 }}
              args:
{{ toYaml $cronJob.args | indent 16 }}
              volumeMounts:
                - name: clamav-volume
                  mountPath: /app/clamav_tmp
                  {{- if $root.Values.mockData.enabled }}
                - name: vets-api-mockdata
                  mountPath: /app/config/vets-api-mockdata
                  {{- end }}
                - name: ddsocket
                  mountPath: /var/run/datadog
{{ toYaml $root.Values.common.volumeMounts | indent 16 }}
              env:
                - name: GIT_REVISION
                  value: {{ $root.Values.image.tag}}
{{ toYaml $root.Values.web.dbMigrate.envSecrets | indent 16 }}
              {{- range $keys, $key := $root.Values.common.secrets }}
              {{- range $secrets, $secret := $key }}
                - name: {{ $secret.env_var }}
                  valueFrom:
                    secretKeyRef:
                      name: {{ $keys }}
                      key: {{ $secret.name }}
              {{- end }}
              {{- end }}
              envFrom:
                - secretRef:
                    name: common-environment-ssm-vars
          restartPolicy: OnFailure
          securityContext:
            fsGroup: {{ $root.Values.fsGroup }}
          volumes:
            {{- if $root.Values.mockData.enabled }}
            - name: vets-api-mockdata
              emptyDir: {}
            {{- end }}
            - name: clamav-volume
              emptyDir: {}
            - name: ddsocket
              hostPath:
                path: /var/run/datadog
{{ toYaml $root.Values.common.volumes | indent 12 }}
{{- end }}
