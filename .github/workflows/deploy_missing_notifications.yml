name: Check VA API Status

on:
  schedule:
    - cron: '59 16 * * 1-5'  # Run at 12:59 PM ET (16:59 UTC) on weekdays
  push:
    branches:
      - 'eb-add-prod-deploy-missing-notification'  # Trigger on pushes to this branch
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-api-status:
    runs-on: ubuntu-latest
    outputs:
      status_summary: ${{ steps.check-api.outputs.status_summary }}
    
    steps:
    - name: Check if today is a valid day
      id: check-day
      run: |
        today=$(date +'%Y-%m-%d')
        
        # Check for holidays (adjust dates as needed)
        holidays=(
          "2024-01-15"  # MLK Day
          "2024-05-27"  # Memorial Day
          "2024-06-19"  # Juneteenth
          "2024-07-04"  # Independence Day
          "2024-09-02"  # Labor Day
          "2024-11-11"  # Veterans Day
          "2024-11-28"  # Thanksgiving
          "2024-12-23"  # Start of Holiday Freeze
          "2024-12-24"
          "2024-12-25"
          "2024-12-26"
          "2024-12-27"
          "2024-12-28"
          "2024-12-29"
          "2024-12-30"
          "2024-12-31"
          "2025-01-01"
          "2025-01-02"
          "2025-01-03"
          "2025-01-04"
          "2025-01-05"
        )
        
        if [[ " ${holidays[@]} " =~ " ${today} " ]]; then
          echo "Holiday - skipping check"
          echo "run_check=false" >> $GITHUB_OUTPUT
        else
          echo "Valid day for check"
          echo "run_check=true" >> $GITHUB_OUTPUT
        fi

    - name: Check API status
      if: steps.check-day.outputs.run_check == 'true' || github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      id: check-api
      run: |
        initial_response=$(curl -s https://api.va.gov/v0/status)
        initial_revision=$(echo $initial_response | jq -r .git_revision)
        echo "Initial git_revision: $initial_revision"
        
        # For testing purposes, we'll reduce the wait time to 1 minute when triggered by a push
        if [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          sleep 60  # Wait for 1 minute
        else
          sleep 1200  # Wait for 20 minutes
        fi
        
        final_response=$(curl -s https://api.va.gov/v0/status)
        final_revision=$(echo $final_response | jq -r .git_revision)
        echo "Final git_revision: $final_revision"
        
        if [ "$initial_revision" == "$final_revision" ]; then
          echo "status_summary=The git_revision at https://api.va.gov/v0/status did not change between 1:00 PM and 1:20 PM ET." >> $GITHUB_OUTPUT
          exit 1  # Fail the job if git_revision didn't change
        else
          echo "status_summary=The git_revision changed from $initial_revision to $final_revision." >> $GITHUB_OUTPUT
        fi

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [check-api-status]
    if: ${{ failure() }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: "us-gov-west-1"

      - uses: department-of-veterans-affairs/action-inject-ssm-secrets@d8e6de3bde4dd728c9d732baef58b3c854b8c4bb
        with:
          ssm_parameter: /devops/VA_VSP_BOT_GITHUB_TOKEN
          env_variable_name: VA_VSP_BOT_GITHUB_TOKEN

      - name: Checkout VSP actions
        uses: actions/checkout@v4
        with:
          repository: department-of-veterans-affairs/vsp-github-actions
          ref: refs/heads/main
          token: ${{ env.VA_VSP_BOT_GITHUB_TOKEN }}
          persist-credentials: false
          path: ./.github/actions/vsp-github-actions

      - uses: department-of-veterans-affairs/action-inject-ssm-secrets@d8e6de3bde4dd728c9d732baef58b3c854b8c4bb
        with:
          ssm_parameter: /devops/github_actions_slack_socket_token
          env_variable_name: SLACK_APP_TOKEN

      - uses: department-of-veterans-affairs/action-inject-ssm-secrets@d8e6de3bde4dd728c9d732baef58b3c854b8c4bb
        with:
          ssm_parameter: /devops/github_actions_slack_bot_user_token
          env_variable_name: SLACK_BOT_TOKEN

      - name: Slack notify
        uses: ./.github/actions/vsp-github-actions/slack-socket
        with:
          slack_app_token: ${{ env.SLACK_APP_TOKEN }}
          slack_bot_token: ${{ env.SLACK_BOT_TOKEN }}
          message: "Vets API Deployment Delay:"
          blocks: "[{\"type\": \"divider\"}, {\"type\": \"section\", \"text\": { \"type\": \"mrkdwn\", \"text\": \":scared_and_sweating_smiley: GitHub Action Runner Workflow failed! :scared_and_sweating_smiley:\n <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.workflow }} Run #${{ github.run_number }}>\n\n*Status Summary:*\n${{ needs.check-api-status.outputs.status_summary }}\"}}, {\"type\": \"divider\"}]"
          channel_id: "C039HRTHXDH"
