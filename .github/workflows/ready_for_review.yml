# Add/remove ready-for-review label based on CI status and approval status
name: Pull Request Ready for Review
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, converted_to_draft]
  pull_request_review:
    types: [submitted, dismissed]
  workflow_run:
    workflows: ["Code Checks"]
    types: [completed]
    branches-ignore:
      - master

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ready-for-review-${{ github.event.pull_request.number || github.event.workflow_run.pull_requests[0].number }}
  cancel-in-progress: true

jobs:
  update-label:
    name: Update Ready for Review Label
    runs-on: ubuntu-latest
    steps:
      - name: Get PR number
        id: pr_number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ github.event_name }}" = "pull_request_review" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Check if workflow_run has associated PRs
            if [ "${{ toJSON(github.event.workflow_run.pull_requests) }}" = "[]" ]; then
              echo "No PR associated with this workflow run, exiting"
              exit 0
            fi
            PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          else
            echo "Unexpected event type: ${{ github.event_name }}"
            exit 1
          fi

          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "Processing PR #${PR_NUMBER}"

      - name: Get PR details
        id: pr_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          # Fetch PR details
          PR_INFO=$(gh api /repos/${{ github.repository }}/pulls/${PR_NUMBER} --jq '{
            draft: .draft,
            head_ref: .head.ref,
            head_sha: .head.sha
          }')

          PR_DRAFT=$(echo "$PR_INFO" | jq -r '.draft')
          PR_BRANCH=$(echo "$PR_INFO" | jq -r '.head_ref')
          PR_HEAD_SHA=$(echo "$PR_INFO" | jq -r '.head_sha')

          echo "pr_draft=${PR_DRAFT}" >> "$GITHUB_OUTPUT"
          echo "pr_branch=${PR_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "pr_head_sha=${PR_HEAD_SHA}" >> "$GITHUB_OUTPUT"

          echo "Draft: ${PR_DRAFT}, Branch: ${PR_BRANCH}"

          # Don't add label to draft PRs
          if [ "$PR_DRAFT" = "true" ]; then
            echo "PR is draft, will remove ready-for-review label if present"
          fi

      - name: Check CI workflow status
        id: ci_status
        if: steps.pr_details.outputs.pr_draft == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ steps.pr_details.outputs.pr_branch }}
        run: |
          all_workflows_passed=true
          REQUIRED_WORKFLOWS=("Code Checks" "Check CODEOWNERS Entries" "Service Tags" "CodeQL")

          echo "=== Checking CI Workflow Status ==="

          for WORKFLOW in "${REQUIRED_WORKFLOWS[@]}"; do
            echo "Checking: $WORKFLOW"

            # Check if workflow is still in progress
            IN_PROGRESS=$(gh run list \
              --repo "${{ github.repository }}" \
              --workflow="${WORKFLOW}" \
              --branch="${PR_BRANCH}" \
              --status=in_progress \
              --limit 10 \
              --json event,headBranch \
              --jq '.[] | select(.event == "pull_request" and .headBranch == "'"${PR_BRANCH}"'") | .headBranch' \
              | head -n 1 || true)

            if [ -n "$IN_PROGRESS" ]; then
              echo "In progress"
              all_workflows_passed=false
              continue
            fi

            # Check if latest run was successful
            LATEST_SUCCESS=$(gh run list \
              --repo "${{ github.repository }}" \
              --workflow="${WORKFLOW}" \
              --branch="${PR_BRANCH}" \
              --status=completed \
              --limit 10 \
              --json event,conclusion,headBranch \
              --jq '.[] | select(.event == "pull_request" and .headBranch == "'"${PR_BRANCH}"'" and .conclusion == "success") | .conclusion' \
              | head -n 1 || true)

            if [ -z "$LATEST_SUCCESS" ]; then
              echo "Not passed"
              all_workflows_passed=false
            else
              echo "Passed"
            fi
          done

          echo ""
          echo "=== CI Status ==="
          if [ "$all_workflows_passed" = "true" ]; then
            echo "All required workflows passed"
          else
            echo "Some workflows pending or failed"
          fi

          echo "all_workflows_passed=${all_workflows_passed}" >> "$GITHUB_OUTPUT"

      - name: Check approval status
        id: approval_status
        if: steps.pr_details.outputs.pr_draft == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
        run: |
          has_approval=false

          echo "=== Checking Approval Status ==="

          # Get all reviews, keeping only most recent per user
          readarray -t APPROVALS < <(
            gh api /repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews --jq '
              [.[] | select(.state == "APPROVED")]
              | sort_by(.submitted_at)
              | reverse
              | unique_by(.user.login)
              | .[].user.login
            ' || true
          )

          if [ "${#APPROVALS[@]}" -gt 0 ]; then
            echo "Has approving reviews from: ${APPROVALS[@]}"
            has_approval=true
          else
            echo "No approving reviews"
            has_approval=false
          fi

          echo "has_approval=${has_approval}" >> "$GITHUB_OUTPUT"

      - name: Update ready-for-review label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr_number.outputs.pr_number }}
          PR_DRAFT: ${{ steps.pr_details.outputs.pr_draft }}
          CI_PASSED: ${{ steps.ci_status.outputs.all_workflows_passed }}
          HAS_APPROVAL: ${{ steps.approval_status.outputs.has_approval }}
        run: |
          echo "=== Label Update Decision ==="
          echo "Draft: ${PR_DRAFT}"
          echo "CI Passed: ${CI_PASSED}"
          echo "Has Approval: ${HAS_APPROVAL}"
          echo ""

          # Determine if label should be present
          if [ "$PR_DRAFT" = "false" ] && [ "$CI_PASSED" = "true" ] && [ "$HAS_APPROVAL" = "true" ]; then
            echo "Adding ready-for-review label"
            gh pr edit ${PR_NUMBER} --add-label "ready-for-review" 2>&1 || echo "Label may already exist"
          else
            echo "Removing ready-for-review label (if present)"
            gh pr edit ${PR_NUMBER} --remove-label "ready-for-review" 2>&1 || echo "Label may not exist"

            # Provide helpful feedback
            if [ "$PR_DRAFT" = "true" ]; then
              echo "Reason: PR is still in draft"
            elif [ "$CI_PASSED" != "true" ]; then
              echo "Reason: CI workflows not all passing"
            elif [ "$HAS_APPROVAL" != "true" ]; then
              echo "Reason: No approving review yet"
            fi
          fi
